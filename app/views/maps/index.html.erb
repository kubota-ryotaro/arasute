<!-- コンテンツ作成 -->
<div id='body_background'>
  <div class='br br_box'>
  </div>
  <div id='content'>
    <%= render 'shared/search_list' %>
    <div id='search_content'>
      <!-- パンくずリスト -->
      <% if params[:search].present? or params[:category].present? %>
        <div id='search_nav'>
          <nav id='pankuzu_nav'>
            <ol id='pankuzu_ol'>
              <li class='pankuzu_li'><%= link_to 'HOME', maps_path %></li>
              <% if params[:search].present? %>
                <li class='pankuzu_li'><%= params[:search] %></li>
              <% else %>
                <li class='pankuzu_li'><%= params[:category] %></li>
              <% end %>
            </ol>
          </nav>
          <div id='search_result'>
            <span>全<%= @maps_station_num.values.inject(:+) %>件</span>
          </div>
        </div>
      <% end %>
      <% @maps_station_num.each do |station, num| %><!-- 入力した駅の数だけdivを作る。 -->
        <ul class="contents">
          <!-- 駅名とカテゴリと検索結果数を表示 -->
          <div class='search_result_station'><%= station %>駅周辺<span class='space'></span><span><%= params[:category] if params[:category].present? %></span><span class='space'></span>検索結果 <%= num %>件</div>
          <div class='search_store'>
            <% @maps.each do |map| %>
              <% if map.store_name.present? and map.station_name === station %><!-- 駅名ごとに振り分ける。 -->
                <li class='content'>
                  <!-- 画像の挿入 -->
                  <% if File.exist?("#{Rails.root}/app/assets/images/#{map.station_name}/#{map.store_name}/main.jpg") or File.exist?("#{Rails.root}/app/assets/images/#{map.station_name}/#{map.store_name}/main.png") %>
                    <div class="image_div">
                      <%= link_to map do %>
                        <span><%= image_tag "#{map.station_name}/#{map.store_name}/main", :size => "170x120" %></span>
                      <% end %>
                    </div>
                  <% end %>
                  <!-- 詳細ボタン -->
                  <%= link_to map, :class => 'detail_btn' do %>
                    <div class='detail_btn_text'>詳細を見る</div>
                  <% end %>
                  <div class='store_info'>
                    <%= link_to map, :class => 'store_info_link' do %>
                      <div class='store_info_msg store_info_name'><%= map.store_name %></div>
                      <%= simple_format(map.text[0, 70] + '...', {class: 'store_info_text'}, wrapper_tag: 'div') %>
                    <% end %>
                    <div class='store_info_btn'><!-- categoryをボタンで表示する。 -->
                      <% map.category[1, map.category.length].split("#").each do |category| %>
                        <div class="store_info_category">
                        <%= link_to category, {controller: "maps", action: "index", category: category}, {:class => 'link_category'} %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </li>
              <% end %>
            <% end %>
          </div>
        </ul>
      <% end %>
      <!-- 地図を表示 -->
      <% if params[:search].present? %>
        <div id='map_idx'></div>
      <% else %>
        <div id='map_idx' hidden></div>
      <% end %>
    </div>
  </div>
</div>



<!-- GoogleMapsAPIのセッティング -->
<script type="text/javascript">
  function initMap() {
    // 入力した駅を中心とする地図のセッティング
    <% @maps.each do |map| %>
        if( <%= map.station_name.try(:include?, "駅") %> ) {
          var latlng = {lat: <%= map.latitude %>, lng: <%= map.longitude %>};
          var map = new google.maps.Map(document.getElementById('map_idx'), {
            zoom: 15,
            center: latlng
          });
          var transitLayer = new google.maps.TransitLayer();
          transitLayer.setMap(map);
        }
    <% end %>

      // 入力した駅にヒットしたそれぞれの店を出力していく。
      <% @maps.each do |map| %>
        (function(){
          var address = "住所：<%= map.address %>";
          var store_name = "<%= map.store_name %>";
          var infowindow = new google.maps.InfoWindow({ content: "店名: <%= map.store_name %><br><%= map.address %>" });

          // マーカーの設定
          var marker = new google.maps.Marker({
            position:{lat: <%= map.latitude %>, lng: <%= map.longitude %>},
            map: map,
            title: store_name,
            icon: null,
            animation: null
          });

          // 駅のマーカーだけアイコンを変える。
          if( <%= map.station_name.try(:include?, "駅") %>) {
            marker.animation = google.maps.Animation.BOUNCE
            marker.icon = { url: '<%= asset_path 'icon.png' %>' }
          }

          // クリックしたら吹き出しを出力し、店名と住所を表示する。
          marker.addListener('click', function() { infowindow.open(map, marker); });
        })();
  <% end %>
  }
</script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap">
</script>

