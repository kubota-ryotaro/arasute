<head>
  <meta charset="utf-8">
  <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
</head>

<!-- タイトルを表示 -->
<div id=title>
  Around the station<br>
  <span id=sub_title> ~駅周辺のお店を検索！ ~</span>
</div>
<div class=space></div>

<!-- 駅名とカテゴリで絞り込む -->
<%= form_tag maps_path, :method => 'get' do %>
  <div id=searchbox>
    <%= text_field_tag :search, params[:search], class: 'search' %>
    <%= select_tag :category, options_for_select([
        ["飲食"],
        ["ショッピングモール"],
        ["CD/DVD レンタルショップ"],
        ["家電量販店"]
    ]), :prompt => params[:category], class: 'search' %>
    <%= submit_tag "検索", class: 'search', :name => nil %>
  </div>
<% end %>
<p>memo memo memo<%= "#{params[:search]}"  %></p>

<!-- 地図を表示 -->
<% if params[:search].present? %>
  <div id=map></div>
<% else %>
  <div id=map hidden></div>
<% end %>

<!-- コンテンツ作成 -->
<div id='content'>
  <ul class="contents">
    <div id=search_result>検索結果 <%= @maps.length - 1 %>件</div>
    <% @maps.each do |map| %>
      <% if map.store_name.present? %>
        <li class='content'>
          <!-- 画像と店名の挿入 -->
          <% if File.exist?("#{Rails.root}/app/assets/images/#{map.store_name}.jpg") or File.exist?("#{Rails.root}/app/assets/images/#{map.store_name}.png") %>
            <div class="image_div">
              <p class='store_info_hot'><a href="ここにリンク先"><%= image_tag map.store_name, :size => "170x120" %>
              <%= map.store_name %>
              </a></p>
            </div>
          <% end %>
          <div class='store_info_hot'>
            <a href="ここにリンク先" class="">
            <!-- カテゴリとタグの挿入 -->
              <p><%= map.large_category %></p>
              <p><%= map.small_category %></p>
            </a>
          </div>
        </li>
      <% end %>
    <% end %>
  </ul>
</div>

<!-- GoogleMapsAPIのセッティング -->
<script type="text/javascript">
  function initMap() {
    // 入力した駅を中心とする地図のセッティング
    <% @maps.each do |map| %>
        if( <%= map.station_name.try(:include?, "駅") %> ) {
          var latlng = {lat: <%= map.latitude %>, lng: <%= map.longitude %>};
          var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: latlng
          });
          var transitLayer = new google.maps.TransitLayer();
          transitLayer.setMap(map);
        }
    <% end %>

      // 入力した駅にヒットしたそれぞれの店を出力していく。
      <% @maps.each do |map| %>
        (function(){
          var address = "住所：<%= map.address %>";
          var store_name = "<%= map.store_name %>";
          var infowindow = new google.maps.InfoWindow({ content: "店名: <%= map.store_name %><br><%= map.address %>" });

          // マーカーの設定
          var marker = new google.maps.Marker({
            position:{lat: <%= map.latitude %>, lng: <%= map.longitude %>},
            map: map,
            title: store_name,
            icon: null,
            animation: null
          });

          // 駅のマーカーだけアイコンを変える。
          if( <%= map.station_name.try(:include?, "駅") %>) {
            marker.animation = google.maps.Animation.BOUNCE
            marker.icon = { url: '<%= asset_path 'icon.png' %>' }
          }

          // クリックしたら吹き出しを出力し、店名と住所を表示する。
          marker.addListener('click', function() { infowindow.open(map, marker); });
        })();
  <% end %>
  }
</script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap">
</script>

