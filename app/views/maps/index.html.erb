<h1>Maps</h1>

<!-- 駅名で絞り込む -->
<%= form_tag maps_path, :method => 'get' do %>
  <div>
    <%= text_field_tag :search, params[:search] %>
    <%= submit_tag "検索", :name => nil %>
  </div>
  <div>
    <%= "#{params[:search]}駅周辺" %>
  </div>
<% end %>

<!-- 地図を表示 -->
<% if params[:search].present? %>
  <div id=map></div>
<% else %>
  <div id=map hidden></div>
<% end %>

<table>
  <thead>
    <tr>
      <th>店名</th>
      <th>カテゴリ</th>
      <th>営業時間</th>
      <th>定休日</th>
      <th colspan="3"></th>
    </tr>
  </thead>
  <tbody>
    <% @maps.each do |map| %>
      <tr>
        <td><%= map.store_name %></td>
        <td><%= map.small_category %></td>
        <td><%= map.business_hours %></td>
        <td><%= map.regular_holiday %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<!-- GoogleMapsAPIのセッティング -->
<script type="text/javascript">
  function initMap() {
    // 入力した駅を中心とする地図のセッティング
    <% @maps.each do |map| %>
        if( <%= map.station_name.try(:include?, "駅") %> ) {
          var latlng = {lat: <%= map.latitude %>, lng: <%= map.longitude %>};
          var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: latlng
          });
          var transitLayer = new google.maps.TransitLayer();
          transitLayer.setMap(map);
        }
    <% end %>

      // 入力した駅にヒットしたそれぞれの店を出力していく。
      <% @maps.each do |map| %>
        (function(){
          var address = "住所：<%= map.address %>";
          var store_name = "<%= map.store_name %>";
          var infowindow = new google.maps.InfoWindow({ content: "店名: <%= map.store_name %><br><%= map.address %>" });

          // マーカーの設定
          var marker = new google.maps.Marker({
            position:{lat: <%= map.latitude %>, lng: <%= map.longitude %>},
            map: map,
            title: store_name,
            icon: null,
            animation: null
          });

          // 駅のマーカーだけアイコンを変える。
          if( <%= map.station_name.try(:include?, "駅") %>) {
            marker.animation = google.maps.Animation.BOUNCE
            marker.icon = { url: '<%= asset_path 'icon.png' %>' }
          }

          // クリックしたら吹き出しを出力し、店名と住所を表示する。
          marker.addListener('click', function() { infowindow.open(map, marker); });
        })();
  <% end %>
  }
</script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap">
</script>
